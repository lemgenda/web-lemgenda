RewriteEngine On

# ========== FORCE HTTPS + WWW ==========
RewriteCond %{HTTPS} off [OR]
RewriteCond %{HTTP_HOST} !^www\.lemgenda\.hr$ [NC]
RewriteRule ^(.*)$ https://www.lemgenda.hr/$1 [L,R=301]

# ========== EXCLUDE ERROR PAGES AND ASSETS ==========
# Don't rewrite error pages, assets, or existing files/directories
RewriteCond %{REQUEST_URI} ^/(400|401|402|403|404|500)\.html$ [NC,OR]
RewriteCond %{REQUEST_URI} \.(css|js|jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot|mp4|webm|mp3|pdf|json)$ [NC,OR]
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# ========== REDIRECT .HTML REQUESTS TO CLEAN URLs ==========
# Redirect ANY .html requests to clean URLs
RewriteCond %{THE_REQUEST} \s/+(.+?)\.html[\s?] [NC]
RewriteRule ^ /%1 [R=301,L,NE]

# ========== MAP CLEAN URLs TO ACTUAL FILES ==========

# 1. Root pages (index, error pages already handled)
RewriteRule ^index$ index.html [L]

# 2. Stranice pages
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{DOCUMENT_ROOT}/stranice/$1.html -f
RewriteRule ^([^.]+)$ /stranice/$1.html [L]

# 3. Usluge pages
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{DOCUMENT_ROOT}/usluge/$1.html -f
RewriteRule ^usluge/([^.]+)$ /usluge/$1.html [L]

# 4. Web-usluge pages
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{DOCUMENT_ROOT}/web-usluge/$1.html -f
RewriteRule ^web-usluge/([^.]+)$ /web-usluge/$1.html [L]

# ========== SPECIFIC PAGE REDIRECTS (Optional but good for SEO) ==========
# These create nice clean URLs without directory structure

# Web services - clean URLs
RewriteRule ^e-commerce-razvoj$ /web-usluge/e-commerce-razvoj.html [L]
RewriteRule ^seo$ /web-usluge/seo.html [L]
RewriteRule ^sem$ /web-usluge/sem.html [L]
RewriteRule ^web-razvoj$ /web-usluge/web-razvoj.html [L]
RewriteRule ^logo-design$ /web-usluge/logo-design.html [L]
RewriteRule ^pristupacnost$ /web-usluge/pristupacnost.html [L]

# Other services
RewriteRule ^ciscenje-racunala$ /usluge/ciscenje-racunala.html [L]
RewriteRule ^ciscenje-smartphona$ /usluge/ciscenje-smartphona.html [L]
RewriteRule ^os-instalacija$ /usluge/os-instalacija.html [L]
RewriteRule ^prilagodeni-razvoj$ /usluge/prilagodeni-razvoj.html [L]

# Content pages
RewriteRule ^kontakt$ /stranice/kontakt.html [L]
RewriteRule ^besplatna-ponuda$ /stranice/besplatna-ponuda.html [L]
RewriteRule ^pregled-radova$ /stranice/pregled-radova.html [L]
RewriteRule ^politika-privatnosti$ /stranice/politika-privatnosti.html [L]
RewriteRule ^uvjeti-koristenja$ /stranice/uvjeti-koristenja.html [L]
RewriteRule ^contact-success$ /stranice/contact-success.html [L]

# ========== CANONICAL URL - TRAILING SLASHES ==========
# Add trailing slash for directories
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^(.*[^/])$ /$1/ [L,R=301]

# Remove trailing slash for files
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)/$ /$1 [L,R=301]

# ========== ERROR DOCUMENTS ==========
ErrorDocument 400 /400.html
ErrorDocument 401 /401.html
ErrorDocument 402 /402.html
ErrorDocument 403 /403.html
ErrorDocument 404 /404.html
ErrorDocument 500 /500.html

# ========== REST OF YOUR CONFIGURATION ==========
# SECURITY HEADERS
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set X-Robots-Tag "all"

    <FilesMatch "\.(ttf|ttc|otf|eot|woff|woff2|font.css)$">
        Header set Access-Control-Allow-Origin "*"
    </FilesMatch>
</IfModule>

# PERFORMANCE & CACHING
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresDefault "access plus 1 hour"
    ExpiresByType text/html "access plus 0 seconds"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
</IfModule>

# COMPRESSION
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/css text/javascript application/javascript image/svg+xml
</IfModule>

# FILE CACHING HEADERS
<IfModule mod_headers.c>
    <FilesMatch "\.(css|js|woff|woff2|ttf|otf)$">
        Header set Cache-Control "public, max-age=2592000, immutable"
    </FilesMatch>
    <FilesMatch "\.(jpg|jpeg|png|gif|ico|svg|webp)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "public, max-age=0, must-revalidate"
    </FilesMatch>
</IfModule>

# BLOCK ACCESS TO SENSITIVE FILES
<FilesMatch "\.(env|md|gitignore|gitattributes|lock|log|ini|conf|config|bak|backup|swp)$">
    Order allow,deny
    Deny from all
</FilesMatch>

<FilesMatch "(^\.|^README\.|^CHANGELOG\.|^LICENSE\.)">
    Order allow,deny
    Deny from all
</FilesMatch>

# PROTECT DIRECTORY LISTINGS
Options -Indexes

# ROBOTS.TXT AND SITEMAP ACCESS
<Files "robots.txt">
    Order allow,deny
    Allow from all
</Files>
<Files "sitemap.xml">
    Order allow,deny
    Allow from all
</Files>